---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: alpinelinux/docker-cli
    tag: latest

params:
  DNS_SUFFIX: ((dnssuffix))
  DOCKER_HOST: ((dockerhost))
  TEMP_VAULT_ROOT_TOKEN: ((tempvaultroottoken))
  TEMP_VAULT_IP: ((tempvaultip))

inputs:
  - name: vault_repo

run:
  path: sh
  args:
  - -c
  - |
    cd vault_repo
    state="Prep"
    docker stack ps vault > /dev/null 2>&1
    if [ $? -ne 0 ]
    then
        printf "Deploying Vault"
        docker stack deploy -c docker-compose.yml vault
        until [ "${state}" == "Running" ]
        do
            printf "."
            state=`docker service ps vault_vault | awk 'FNR == 2 {print $6}'`
        done
        echo "Done"
    fi
    docker stack ls
    docker service ls
    apk add --update jq vault
    chmod +x vault_init.sh
    chown root:root /usr/sbin/vault
    ash ./vault_init.sh
