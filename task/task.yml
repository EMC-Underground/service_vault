---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: alpinelinux/docker-cli
    tag: latest

params:
  DNS_SUFFIX: ((dnssuffix))
  DOCKER_HOST: ((dockerhost))

inputs:
  - name: vault_repo

run:
  path: sh
  args:
  - -c
  - |
    cd vault_repo
    docker stack ps vault > /dev/null
    if [ $? -ne 0 ]
    then
        docker stack deploy -c docker-compose.yml vault
        echo "Deployed Vault"
    fi
    docker stack ls
    docker service ls
    sleep 5
    apk add --update jq vault
    chmod +x vault_init.sh
    chown root:root /usr/sbin/vault
    ash ./vault_init.sh
